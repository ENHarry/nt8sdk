# PropTrader v3 Trading Configuration
# =====================================

# Pattern Recognition Settings
pattern_recognition:
  # Enable/disable pattern-based trade blocking
  enable_override: true
  
  # Override mode:
  # - "strict": Pattern always overrides signals
  # - "tiered": Consider pattern confidence AND signal strength
  # - "advisory": Log pattern but don't block trades
  override_mode: "tiered"
  
  # Alert if same pattern detected N times consecutively
  stuck_detection_threshold: 50
  
  # Minimum pattern confidence (%) to block trade
  min_confidence_for_override: 85
  
  # Tiered mode thresholds
  tiered_thresholds:
    # If pattern confidence > 90% and ADX < 30, block trade
    high_confidence_adx_max: 30
    # If pattern confidence > 80% and ADX < 40, block trade
    medium_confidence_adx_max: 40
    # If ADX > 50, allow trade regardless of pattern
    strong_trend_adx: 50

# Market Regime Settings
market_regime:
  # Enable ranging market trading strategy
  enable_ranging_trading: true
  
  # ADX threshold to classify as ranging (vs choppy)
  adx_ranging_threshold: 20
  
  # ADX threshold to classify as trending
  adx_trending_threshold: 25
  
  # Minimum range quality score (0-1) to trade ranging strategy
  range_quality_threshold: 0.7
  
  # Use ML-based regime detection
  use_ml_regime_detection: true
  ml_regime_min_confidence: 0.7  # Fall back to ADX if ML < threshold

# Ranging Signal Settings
ranging_signals:
  # Bollinger Bands parameters
  bollinger_bands:
    period: 20
    std_dev: 2.0
    oversold_threshold: 0.1   # %B value (0 = lower band)
    overbought_threshold: 0.9  # %B value (1 = upper band)
  
  # Stochastic Oscillator parameters
  stochastic:
    k_period: 14
    d_period: 3
    oversold: 20
    overbought: 80
  
  # RSI parameters
  rsi:
    period: 14
    oversold: 30
    overbought: 70
  
  # ADX/DI parameters
  adx_di:
    period: 7                    # ADX/DI calculation period (try 7 or 14)
    adx_threshold: 25.0           # ADX threshold for trend detection
    di_min_threshold: 19.0        # Minimum DI value for entry confirmation
  
  # Range detection parameters
  range_detection:
    lookback_bars: 50
    min_width_pct: 0.5  # Minimum range width as % of price
    quality_threshold: 0.7
    min_touches: 2  # Minimum touches at support/resistance
  
  # Position sizing for ranging trades (relative to trending)
  position_multiplier: 0.8
  
  # Stop/Target ATR multipliers
  atr_multiplier_stop: 1.5
  atr_multiplier_target: 1.0  # Tighter targets in ranging

# Session Settings
sessions:
  # Enable session-based filtering and adjustments
  enable_session_filtering: true
  
  # Timezone for session calculations
  timezone: "America/Chicago"
  
  # Allow trading during off-hours (low liquidity)
  allow_off_hours_trading: false
  
  # Minutes before session change to warn
  warn_before_transition: 15
  
  # Risk adjustments per session
  session_risk:
    asia:
      position_multiplier: 0.7
      spread_tolerance: 1.5
    europe:
      position_multiplier: 0.9
      spread_tolerance: 1.0
    us:
      position_multiplier: 1.0
      spread_tolerance: 1.0
    overlap:
      position_multiplier: 1.0
      spread_tolerance: 0.8  # Expect tightest spreads
    off_hours:
      position_multiplier: 0.5
      spread_tolerance: 2.0

# HTF (Higher Timeframe) Filter Settings
htf_filter:
  # Enable higher timeframe trend filter
  enabled: true
  
  # Primary HTF timeframe to use
  primary_timeframe: "1m"
  
  # Fallback if primary not available
  fallback_timeframe: "5m"
  
  # Minimum bars required for HTF analysis
  min_bars: 15
  
  # Log warning throttle (seconds between warnings)
  warning_throttle_seconds: 300

# Signal Generation Settings
signal_generation:
  # Minimum signal quality grade to trade
  min_grade: "MEDIUM"  # "LOW", "MEDIUM", "HIGH"
  
  # Require MTF (multi-timeframe) confirmation
  require_mtf_confirmation: true
  
  # Minimum MTF alignment score (0-1)
  min_mtf_alignment: 0.6
  
  # Enable signal weighting via Random Forest
  use_rf_weighting: true
  rf_min_win_probability: 0.52

# Risk Management
risk_management:
  # Maximum position size (contracts)
  max_position_size: 10
  
  # Maximum daily loss (in account currency)
  max_daily_loss: 5000
  
  # Maximum drawdown percentage before stopping
  max_drawdown_pct: 15
  
  # Use session-aware risk adjustments
  use_session_risk: true
  
  # Use Monte Carlo optimized position sizing
  use_mc_sizing: true

# Bracket Order Management
bracket_orders:
  # OCO (One-Cancels-Other) mode:
  # - true: Use NT8 OCO - NT8 auto-cancels other order when one fills
  # - false: Bot manually cancels other order when one fills/cancels
  oco_enabled: false

# Limit Order Settings
limit_orders:
  # Timeout in seconds for unfilled limit orders (default: 300 = 5 minutes)
  # Set to 0 to disable timeout (orders will persist until filled or manually cancelled)
  timeout_seconds: 300
  
  # Offset from current price for limit orders (in points)
  # Symbol-specific offsets (GC/MGC use 2.5, others use 1.5)
  default_offset: 2.5
  default_offset_other: 1.5
  
  # Whether to use limit orders by default
  use_limit_orders: true

# Position Management Settings
position_management:
  # Maximum hold time in seconds before forced exit (default: 300 = 5 minutes)
  max_hold_seconds: 300
  
  # Seconds to hold position before allowing breakeven move
  hold_secs_before_breakeven: 60.0
  
  # Seconds profit must be sustained before breakeven move
  sustain_secs_before_breakeven: 15.0
  
  # Stale P&L timeout - close if P&L hasn't changed in this many seconds
  stale_pnl_timeout_seconds: 180
  
  # Minimum $ change to consider P&L as "moved" (avoid noise)
  pnl_change_threshold: 0.50

# Stop Loss / Take Profit Settings
sl_tp:
  # Default stop loss in points
  stop_loss_points: 30.0
  
  # Default take profit in points
  take_profit_points: 40.0
  
  # Minimum risk/reward ratio required
  min_risk_reward_ratio: 1.0

# Trading Parameters
trading_parameters:
  # Default quantity per trade
  default_quantity: 1
  
  # ADX threshold for ranging market classification
  adx_ranging_threshold: 20.0
  
  # Maximum consecutive losses before halting trading
  consecutive_loss_limit: 3
  
  # Minimum seconds between trade entries
  min_seconds_between_entries: 5
  
  # Trade interval (seconds between trade checks)
  trade_interval: 5.0

# Reversal Detection Settings
reversal_detection:
  # Enable flip on reversal (use NT8 reverse_position)
  flip_on_reversal: false
  
  # Maximum number of flips allowed per original position
  max_flips_per_position: 1
  
  # Number of consecutive signals required to signal a reversal
  mark: 5
  
  # Minimum seconds to hold position before allowing reversals
  min_position_hold_seconds: 60
  
  # Allow early exit if profit >= this many points
  min_profit_for_early_exit: 2.0

# Loop Intervals (seconds)
loop_intervals:
  # Signal generation loop interval
  signal_loop: 1.0
  
  # Trading/execution loop interval  
  trading_loop: 0.5
  
  # Position monitoring loop interval
  monitoring_loop: 1.0

# Logging & Monitoring
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR
  level: "INFO"
  
  # Log signal details
  log_signals: true
  
  # Log regime changes
  log_regime_changes: true
  
  # Log session transitions
  log_session_changes: true
  
  # Log ML predictions
  log_ml_predictions: true

# Debug Settings
debug:
  # Enable debug mode (more verbose logging)
  enabled: false
  
  # Save signal history for analysis
  save_signal_history: true
  
  # Save regime history
  save_regime_history: true

# =============================================================================
# ADAPTIVE POSITION PROTECTION
# =============================================================================
# Dynamic breakeven triggers, trailing stops, and Running TP that scale based
# on trend strength (smoothed ADX) and instrument volatility (rolling ATR).
# Positions in strong trends get significantly more breathing room.
#
# Formula for BE trigger:
#   adaptive_trigger = base_trigger * (1 + smoothed_adx / adx_be_divisor) * (current_atr / rolling_avg_atr)
#
# Formula for hold time:
#   adaptive_hold = base_hold * (1 + smoothed_adx / adx_hold_divisor) * (current_atr / rolling_avg_atr)
#
# Formula for trail distance:
#   adaptive_trail = max(min_trail, current_atr * (base_multiplier + smoothed_adx / adx_trail_divisor))
#
# Formula for Running TP offset:
#   adaptive_offset = base_offset * (1 + smoothed_adx / adx_running_tp_divisor)
# =============================================================================

adaptive_protection:
  # Enable/disable adaptive protection (if disabled, uses fixed values)
  enabled: true
  
  # ADX divisors (higher = less aggressive scaling)
  adx_be_divisor: 50              # BE trigger scaling: 1 + ADX/50 (ADX 50 = 2x trigger)
  adx_hold_divisor: 100           # Hold time scaling: 1 + ADX/100 (ADX 50 = 1.5x hold)
  adx_trail_divisor: 100          # Trail distance scaling: base + ADX/100 (ADX 50 = +0.5x ATR)
  adx_running_tp_divisor: 50      # Running TP offset scaling: 1 + ADX/50 (ADX 50 = 2x offset)
  
  # Rolling average periods
  atr_rolling_period: 14          # Number of ATR values to average
  adx_smoothing_period: 3         # EMA periods for ADX smoothing
  
  # Warmup behavior (before rolling averages stabilize)
  warmup_conservative_multiplier: 1.5  # Multiply base values by this during warmup
  
  # S/R buffer for Running TP (when stop would pass S/R level)
  sr_buffer_points: 0.5           # Place stop this many points before S/R
  
  # ADX Trend Classification Thresholds:
  # < 20: WEAK (no clear trend, ranging market)
  # 20-30: MODERATE (trend developing)
  # 30-50: STRONG (established, tradeable trend)
  # 50-70: VERY_STRONG (powerful momentum)
  # > 70: EXTREME (rare, often signals exhaustion)
  weak_trend_adx_threshold: 20      # ADX below this = weak/no trend
  moderate_trend_adx_threshold: 30  # ADX above this = moderate/developing trend
  strong_trend_adx_threshold: 50    # ADX above this = strong established trend
  very_strong_trend_adx_threshold: 70  # ADX above this = very strong/extreme trend
  
  # BE rejection cooldown (prevents rapid retry spam after rejection)
  be_rejection_cooldown_secs: 5.0    # Seconds to wait after BE rejection before retrying
  
  # Dynamic stop buffer (prevents rejection when market moves during order placement)
  # Buffer = max(tick_size * be_min_stop_buffer_ticks, current_atr * be_atr_buffer_multiplier)
  be_min_stop_buffer_ticks: 3       # Minimum buffer in ticks when ATR unavailable
  be_atr_buffer_multiplier: 0.1     # ATR multiplier for dynamic buffer
# =============================================================================
# HISTORICAL DATA SETTINGS
# =============================================================================
# Control whether historical data files are loaded for indicator warmup.
# When disabled, the bot uses ONLY live data from NT8 (more accurate but slower warmup).

# =============================================================================
# NT8 NATIVE INDICATORS
# =============================================================================
# Use indicator values directly from NinjaTrader 8 (calculated by the strategy)
# instead of recalculating with TA-Lib in Python. This ensures perfect accuracy
# and lowest latency since NT8 indicators are pre-calculated.

nt8_indicators:
  # Enable/disable NT8 native indicator integration
  enabled: true
  
  # When true, skips the warmup period since NT8 provides pre-warmed indicators
  bypass_warmup: true
  
  # TCP port for streaming indicators (used by NTPythonIndicatorExporter strategy)
  tcp_port: 50005
  
  # Fall back to file-based reading if TCP is not available
  fallback_to_file: true
  
  # Primary indicator file location (relative to Documents folder)
  primary_file: "NT8_Python_Data/nt8_indicators.csv"

historical_data:
  # Enable/disable loading historical data from files
  # When false: Uses only live NT8 data, warmup extends to 15 minutes
  # When true: Uses historical files for fast indicator warmup
  use_historical_data: true  # Set to false for most accurate live indicators
  
  # Maximum historical bars to load (limits lookback for indicator calculation)
  # 60 bars is sufficient for all indicators (ADX=14, MACD=26+9, RSI=14)
  # Set to 0 or null to load all available historical data
  max_historical_bars: 60
  
  # Maximum age of historical data in minutes before it's considered stale
  # If the most recent historical bar is older than this, historical data is skipped
  # and the bot will use live-only mode with extended warmup
  max_historical_age_minutes: 10
  
  # Warmup period when historical data is disabled (seconds)
  # 15 minutes (900s) allows accumulation of ~15 1-min bars for basic indicators
  live_only_warmup_seconds: 900
  
  # Warmup period when historical data is enabled (seconds)
  # Shorter since indicators can warm up from historical data
  with_historical_warmup_seconds: 60

# =============================================================================
# PLAYBACK MODE SETTINGS
# =============================================================================
# NT8 Playback streams historical data but doesn't provide the playback timestamp.
# The bot must know the playback start date/time to filter historical data properly.
# Without this, indicators will be calculated on "future" data and be incorrect.

playback:
  # Manual playback start date/time (required for playback mode)
  # Format: "YYYY-MM-DD HH:MM" in ET timezone
  # Set this to match your NT8 playback start position
  # Example: "2026-01-01 00:00" for Jan 1, 2026 at 12:00 AM ET
  start_datetime: "2026-01-05 00:00"  # Set to null to auto-detect (may be unreliable)
  
  # Auto-detection method (when start_datetime is null):
  # - "price_match": Try to match live prices to historical data timestamps
  # - "none": Don't auto-detect, use system time (WARNING: will be wrong)
  auto_detect_method: "price_match"
  
  # Price tolerance for auto-detection (how close prices must match)
  price_match_tolerance: 0.5  # Points difference allowed
  
  # Fallback behavior if auto-detect fails
  # - "warn_and_continue": Log warning, use historical data as-is (may be wrong)
  # - "purge_historical": Discard all historical data, start fresh with live bars
  auto_detect_fallback: "purge_historical"